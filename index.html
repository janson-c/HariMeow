<body>

  <df-messenger
    intent="WELCOME"
    chat-title="HariMeow"
    agent-id="dabea203-1958-4c0d-89d6-5490f4314805"
    language-code="en"
  ></df-messenger>

  <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>

  <script>
    window.addEventListener("df-messenger-loaded", function () {
      // ... (all your avatar-fixing code is in here) ...
      // ... (no changes needed here) ...
    });
  </script>


  <script>
    // 1. Select the df-messenger element
    const dfMessenger = document.querySelector('df-messenger');

    // 2. Add an event listener to check every response from the bot
    dfMessenger.addEventListener('df-response-received', function (event) {
      
      // 3. Check the response messages for a payload
      const messages = event.detail.response.queryResult.responseMessages;
      if (!messages) return;

      // Find the first message that has a 'payload'
      const payloadMsg = messages.find(m => m.payload);
      if (!payloadMsg) return;

      // 4. Check if the payload is our "setLanguage" command
      // Note: We have to dig into 'fields' and 'stringValue'
      const payload = payloadMsg.payload.fields;
      if (payload && payload.command.stringValue === 'setLanguage') {
        
        // 5. Get the new language from the payload
        const newLang = payload.lang.stringValue;
        console.log('Language switch signal received. Setting lang to:', newLang);

        // 6. This is the magic line!
        // It updates the widget's language attribute.
        // All future messages will now use this language.
        dfMessenger.lang = newLang;
      }
    });
  </script>

</body>
