<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HariMeow Chatbot</title>

  <style>
    df-messenger {
      --df-messenger-bot-message: #ffffff;
      --df-messenger-font-color: #222;
      --df-messenger-send-icon: #000;
      --df-messenger-user-message: #e6f7ff;
      --df-messenger-width: 375px;
      --df-messenger-height: 600px;
      border-radius:12px;
      box-shadow:0 8px 24px rgba(0,0,0,0.12);
      overflow:hidden;
    }

    /* Add bot avatar next to bot messages */
    df-messenger .df-messenger-message.bot .message {
      position: relative;
      padding-left: 56px !important; /* space for avatar */
    }
    df-messenger .df-messenger-message.bot .message::before {
      content: "";
      position: absolute;
      left: 10px;
      top: 10px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      /* Cleaned up the URL path for your tiger avatar */
      background-image: url(https://raw.githubusercontent.com/janson-c/HariMeow/main/cartoon%20avatar.jpeg);
      background-size: cover;
      background-position: center;
      box-shadow: 0 1px 6px rgba(0,0,0,0.15);
    }
  </style>
</head>
<body>

  <df-messenger
    intent="WELCOME"
    chat-title="HariMeow"
    agent-id="dabea203-1958-4c0d-89d6-5490f4314805"
    language-code="en"
  ></df-messenger>

  <script src="https://www.gstatic.com/dialogflow-console/fast/messenger/bootstrap.js?v=1"></script>

<script>
    window.addEventListener("df-messenger-loaded", function () {
      
      const dfMessenger = document.querySelector("df-messenger");
      if (!dfMessenger) {
        console.error("Chatbot loaded event fired, but element not found!");
        return;
      }
      console.log("[DEBUG] Chatbot is loaded. Running custom code...");

      // ---
      // PART 1: YOUR AVATAR CODE (No changes)
      // ---
      const wait = setInterval(() => {
        const bubble = dfMessenger.shadowRoot.querySelector("df-messenger-chat-bubble");
        if (!bubble) return;
        const root = bubble.shadowRoot;
        if (!root) return;
        const button = root.querySelector(".df-chat-bubble-button");
        if (!button) return;
        
        clearInterval(wait);
        button.innerHTML = "";
        button.style.backgroundImage =
          'url("https://raw.githubusercontent.com/janson-c/HariMeow/main/cartoon%20avatar.jpeg")';
        // ... (all your other avatar styles) ...
        button.style.width = "70px";
        button.style.height = "70px";
        button.style.borderRadius = "50%";
      }, 100);

      // ---
      // PART 2: NEW "LOUDER" LANGUAGE SWITCHER
      // ---
      console.log("[DEBUG] Adding language switch listener...");
      
      dfMessenger.addEventListener('df-response-received', function (event) {
        
        console.log("[DEBUG] Response received!");

        // 1. Check for the main response object
        if (!event.detail.response) {
            console.error("[DEBUG] FATAL: event.detail.response is MISSING!");
            return;
        }

        // 2. Check for the queryResult
        if (!event.detail.response.queryResult) {
            console.error("[DEBUG] FATAL: queryResult object is MISSING!");
            console.log("[DEBUG] Full response object was:", event.detail.response);
            return;
        }
        
        console.log("[DEBUG] queryResult object was found.");
        const queryResult = event.detail.response.queryResult;

        // 3. This is the check that was failing.
        if (!queryResult.responseMessages) {
            console.error("[DEBUG] ERROR: queryResult.responseMessages is MISSING or empty!");
            // We know the intent matched, so fulfillmentText MUST be here
            console.log("[DEBUG] The bot's reply (fulfillmentText) was:", queryResult.fulfillmentText);
            return;
        }
        
        // 4. If we get this far, the problem IS the payload.
        console.log("[DEBUG] responseMessages array was found. Checking for payloads...");
        const messages = queryResult.responseMessages;

        const payloadMsg = messages.find(m => m.payload);
        
        if (payloadMsg) {
          console.log("[DEBUG] Payload was found in the response!", payloadMsg.payload);
          const payload = payloadMsg.payload.fields;
          
          if (payload && payload.command && payload.command.stringValue === 'setLanguage') {
            const newLang = payload.lang.stringValue;
            
            console.log('Language switch signal received. Setting lang to:', newLang);
            dfMessenger.lang = newLang; 
          } else {
            console.log('[DEBUG] Payload found, but it was not the setLanguage command.');
          }
        } else {
          console.log('[DEBUG] No payload was found in this response.');
        }
      });
    });
  </script>

